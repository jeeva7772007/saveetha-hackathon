<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MediTriageAI ‚Äî My History</title>
    <meta name="description" content="View your past symptom analyses and medical risk assessments." />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet" />
    <link rel="stylesheet" href="style.css" />
</head>

<body>
    <div class="bg-orb orb-1"></div>
    <div class="bg-orb orb-2"></div>
    <div class="bg-orb orb-3"></div>

    <!-- Header -->
    <header class="header">
        <div class="header-inner">
            <div class="logo">
                <div class="logo-icon">
                    <svg viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="20" cy="20" r="20" fill="url(#lgh)" />
                        <path d="M20 10v20M10 20h20" stroke="white" stroke-width="3.5" stroke-linecap="round" />
                        <defs>
                            <linearGradient id="lgh" x1="0" y1="0" x2="40" y2="40" gradientUnits="userSpaceOnUse">
                                <stop stop-color="#06b6d4" />
                                <stop offset="1" stop-color="#6366f1" />
                            </linearGradient>
                        </defs>
                    </svg>
                </div>
                <div class="logo-text">
                    <span class="logo-title">MediTriageAI</span>
                    <span class="logo-sub">Intelligent Risk Assessment</span>
                </div>
            </div>
            <nav class="header-nav">
                <a href="index.html" class="nav-link">‚Üê Analyze</a>
                <span class="nav-user" id="navUser"></span>
                <button class="nav-logout-btn" id="logoutBtn" onclick="handleLogout()">Logout</button>
            </nav>
        </div>
    </header>

    <main class="main">
        <section class="hero" style="margin-bottom:28px;">
            <h1 class="hero-title">Your <span class="gradient-text">Analysis History</span></h1>
            <p class="hero-sub">Past symptom analyses are saved automatically after each assessment.</p>
        </section>

        <!-- Loading -->
        <div id="historyLoading" style="text-align:center;padding:60px 0;color:var(--text-3);">
            <div class="loading-ring" style="margin:0 auto 16px;">
                <div class="ring-inner"></div>
                <div class="ring-pulse"></div>
            </div>
            Loading history‚Ä¶
        </div>

        <!-- Empty State -->
        <div id="historyEmpty" style="display:none;" class="card" style="text-align:center;padding:48px;">
            <div style="font-size:3rem;margin-bottom:16px;">üîç</div>
            <h3 style="margin-bottom:8px;">No analyses yet</h3>
            <p style="color:var(--text-2);margin-bottom:20px;">Your symptom analyses will appear here after you use the
                app.</p>
            <a href="index.html" class="analyze-btn"
                style="display:inline-flex;width:auto;padding:12px 28px;text-decoration:none;">Start Analyzing</a>
        </div>

        <!-- History List -->
        <div id="historyList" style="display:none;"></div>
    </main>

    <footer class="footer">
        <p>MediTriageAI &copy; 2026 &nbsp;¬∑&nbsp; Saveetha Hackathon &nbsp;¬∑&nbsp; For educational purposes only</p>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase.js"></script>
    <script>
        const riskColor = { low: 'var(--green)', medium: 'var(--yellow)', high: 'var(--orange)', critical: 'var(--red)' };
        const riskEmoji = { low: 'üü¢', medium: 'üü°', high: 'üü†', critical: 'üî¥' };

        async function init() {
            const { data: { session } } = await _supabase.auth.getSession();
            if (!session) { window.location.href = 'login.html'; return; }
            document.getElementById('navUser').textContent = session.user.email;
            loadHistory(session.user.id);
        }

        async function loadHistory(userId) {
            const { data, error } = await _supabase
                .from('analyses')
                .select('*')
                .eq('user_id', userId)
                .order('created_at', { ascending: false });

            document.getElementById('historyLoading').style.display = 'none';

            if (error || !data || data.length === 0) {
                document.getElementById('historyEmpty').style.display = 'block';
                return;
            }

            const list = document.getElementById('historyList');
            list.style.display = 'block';
            list.innerHTML = data.map((row, i) => {
                const date = new Date(row.created_at).toLocaleString('en-IN', {
                    day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit'
                });
                const risk = (row.risk_level || 'unknown').toLowerCase();
                const conf = row.confidence ? Math.round(row.confidence * 100) : 0;
                const emerg = row.is_emergency;
                return `
          <div class="hist-card card" onclick="toggleDetail(${i})">
            <div class="hist-header">
              <div class="hist-left">
                <span class="hist-emoji">${riskEmoji[risk] || '‚ö™'}</span>
                <div>
                  <div class="hist-disease">${row.disease || 'Unknown'}</div>
                  <div class="hist-meta">${date} &nbsp;¬∑&nbsp; ${conf}% confidence</div>
                </div>
              </div>
              <div class="hist-right">
                <span class="hist-risk" style="color:${riskColor[risk] || 'inherit'}">${row.risk_level || '‚Äî'}</span>
                ${emerg ? '<span class="hist-emergency-badge">üö® Emergency</span>' : ''}
                <span class="hist-chevron" id="chev-${i}">‚ñº</span>
              </div>
            </div>
            <div class="hist-prompt">"${(row.prompt || '').substring(0, 120)}${row.prompt && row.prompt.length > 120 ? '‚Ä¶' : ''}"</div>
            <div class="hist-detail" id="detail-${i}" style="display:none;">
              <div class="analysis-content" style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border);">
                ${formatAnalysis(row.full_result?.detailed_analysis || '')}
              </div>
            </div>
          </div>
        `;
            }).join('');
        }

        function toggleDetail(i) {
            const d = document.getElementById('detail-' + i);
            const c = document.getElementById('chev-' + i);
            const open = d.style.display !== 'none';
            d.style.display = open ? 'none' : 'block';
            c.textContent = open ? '‚ñº' : '‚ñ≤';
        }

        async function handleLogout() {
            await _supabase.auth.signOut();
            window.location.href = 'login.html';
        }

        function formatAnalysis(text) {
            if (!text) return '<em style="color:var(--text-3)">No detailed analysis saved.</em>';
            return text
                .replace(/^## (.+)$/gm, '<h2>$1</h2>')
                .replace(/^### (.+)$/gm, '<h3>$1</h3>')
                .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                .replace(/^(\d+\.) (.+)$/gm, '<div style="margin:4px 0;padding-left:8px;"><strong>$1</strong> $2</div>')
                .replace(/^---$/gm, '<hr style="border:none;border-top:1px solid rgba(255,255,255,0.06);margin:12px 0;">')
                .replace(/\n/g, '<br>');
        }

        init();
    </script>
</body>

</html>